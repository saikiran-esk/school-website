<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Progress</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <h2>Progress / Marks</h2>
  <label>Student Name<input id="studentName"></label><br>
  <label>Class<input id="classSelect"></label><br>

  <table id="subjectRows" border="1">
    <tr><th>Subject</th><th>FA</th><th>SA</th></tr>
    <tr><td class="sub">Math</td><td><input class="fa" type="number" value="0"></td><td><input class="sa" type="number" value="0"></td></tr>
    <tr><td class="sub">Science</td><td><input class="fa" type="number" value="0"></td><td><input class="sa" type="number" value="0"></td></tr>
    <tr><td class="sub">English</td><td><input class="fa" type="number" value="0"></td><td><input class="sa" type="number" value="0"></td></tr>
  </table>

  <button id="saveMarks">Save Marks</button>
  <button id="loadRecent">Load Recent</button>

  <script>
    document.getElementById('saveMarks').addEventListener('click', async ()=>{
      const user = auth.currentUser; if(!user) return location.href='loginform.html';
      const rows = document.querySelectorAll('#subjectRows tr');
      const marks = [];
      for (let i=1;i<rows.length;i++){
        const r = rows[i];
        const subject = r.querySelector('.sub').textContent.trim();
        const fa = Number(r.querySelector('.fa').value)||0;
        const sa = Number(r.querySelector('.sa').value)||0;
        marks.push({ subject, fa, sa, total: fa+sa });
      }
      const finalPercent = marks.reduce((s,m)=>s+m.total,0)/(marks.length*100)*100;
      await db.collection('progress').add({
        studentName: document.getElementById('studentName').value || '',
        class: document.getElementById('classSelect').value || '',
        marks, finalPercent, createdBy: user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert('Saved marks');
    });

    document.getElementById('loadRecent').addEventListener('click', async ()=>{
      const user = auth.currentUser; if(!user) return location.href='loginform.html';
      const snap = await db.collection('progress').where('createdBy','==',user.uid).orderBy('createdAt','desc').limit(1).get();
      if (snap.empty) return alert('No marks saved');
      const d = snap.docs[0].data();
      document.getElementById('studentName').value = d.studentName || '';
      document.getElementById('classSelect').value = d.class || '';
      // fill table
      for (let i=0;i<d.marks.length;i++){
        const row = document.querySelectorAll('#subjectRows tr')[i+1];
        if (!row) continue;
        row.querySelector('.fa').value = d.marks[i].fa;
        row.querySelector('.sa').value = d.marks[i].sa;
      }
    });
  </script>
</body>
</html>
