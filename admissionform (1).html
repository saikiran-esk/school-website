<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admission Form</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <h2>Admission Form</h2>
  <label>Name</label><input id="name"><br>
  <label>DOB</label><input id="dob" type="date"><br>
  <label>Phone</label><input id="phone"><br>
  <label>Class</label><input id="sclass"><br>
  <button id="saveForm">Save</button>

  <script>
    let editingId = null;
    window.addEventListener('DOMContentLoaded', ()=>{
      const load = localStorage.getItem('loadStudentFirestore');
      if (load) {
        const parsed = JSON.parse(load);
        editingId = parsed.id;
        const data = parsed.data;
        document.getElementById('name').value = data.name || '';
        document.getElementById('dob').value = data.dob || '';
        document.getElementById('phone').value = data.phone || '';
        document.getElementById('sclass').value = data.sclass || '';
        localStorage.removeItem('loadStudentFirestore');
      }
    });

    document.getElementById('saveForm').onclick = async () => {
      const user = auth.currentUser;
      if (!user) return alert('Login required');
      if (!user.emailVerified) return alert('Verify your email first');
      const payload = {
        name: document.getElementById('name').value.trim(),
        dob: document.getElementById('dob').value,
        phone: document.getElementById('phone').value.trim(),
        sclass: document.getElementById('sclass').value.trim(),
        createdBy: user.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      try {
        if (editingId) {
          await db.collection('admissions').doc(editingId).set(payload, { merge: true });
          alert('Updated');
        } else {
          await db.collection('admissions').add(payload);
          alert('Saved');
        }
        location.href = 'savedforms.html';
      } catch (e) { alert(e.message); console.error(e); }
    };
  </script>
</body>
</html>
